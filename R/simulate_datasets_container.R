#' Simulate scRNA-seq Datasets
#'
#' This is the core function of simulating scRNA-seq datasets via establishing Docker containers.
#'
#' @param method A character or a string of methods or NULL. It can be \code{all}
#' as all methods are used to estimate paramters from real data. If NULL, the
#' argument \code{parameters} must be generated by [simpipe::estimate_parameters()].
#' @param parameters NULL or the object generated by [simpipe::estimate_parameters()].
#' If NULL, you must input the argument \code{method} above and the default
#' parameters will be used to perform the simulation step.
#' @param ref_data A matrix for one dataset or a list of datasets with their own
#' names. This is usually unused except for some methods, e.g. SCRIP.
#' @param other_prior A list with names of certain parameters. Some methods need
#' extra parameters to execute the estimation step, so you must input them. In
#' simulation step, the number of cells, genes, groups, batches, the percent of
#' DEGs and other variables are usually customed, so before simulating a dataset
#' you must point it out.
#' @param n The time(s) that users want to perform the simulation step with every
#' method.
#' @param seed A random seed. An integer or a vector of integers. If you want to
#' simulate twice or more times by every method you have chosen, it should be a
#' vector. If you do not input this parameter, the default value(s) will be used.
#' @param return_format A character. Alternatives choices: list, SingleCellExperiment,
#' Seurat and h5ad.
#' @param verbose Logical. Whether to return messages or not.
#'
#' @importFrom stringr str_split
#' @importFrom stats setNames
#'
#' @export
#'
simulate_datasets_container <- function(
    method = NULL,
    parameters = NULL,
    ref_data = NULL,
    other_prior = NULL,
    n = 1,
    seed = simutils::random_seed(),
    return_format = "SingleCellExperiment",
    verbose = TRUE
){

  # Check-----------------------------------------------------------------------
  assertthat::assert_that(is.list(parameters) | is.null(parameters))
  if(is.null(method) & is.null(parameters)){
    stop("You must input information about either method or parameters!")
  }
  if(!is.null(parameters)){
    assertthat::assert_that("simpipe_estimation" %in% class(parameters))
  }

  # Prepare methods-------------------------------------------------------------

  ## All methods
  all_methods <- c("BASiCS",
                   "BEARscc",
                   "CancerInSilico",
                   "dropsim",
                   "dyngen",
                   "dyntoy",
                   "ESCO",
                   "hierarchicell",
                   "Kersplat",
                   "Lun",
                   "Lun2",
                   "MFA",
                   "muscat",
                   "phenopath",
                   "POWSC",
                   "powsimR",
                   "PROSSTT",
                   "scDD",
                   "scDesign",
                   "scDesign2",
                   "scGAN",
                   "SCRIP",
                   "Simple",
                   "SparseDC",
                   "SPARSim",
                   "Splat",
                   "SplatPop",
                   "SPsimSeq",
                   "SymSim",
                   "TedSim",
                   "VeloSim",
                   "zinbwave",
                   "zinbwaveZinger",
                   "zingeR")
  ## data name and method name
  if(!is.null(parameters)){
    data_name <- stringr::str_split(names(parameters),
                                    pattern = "_",
                                    simplify = T)[, 1]
    if(is.null(method)){
      method <- stringr::str_split(names(parameters),
                                   pattern = "_",
                                   simplify = T)[, 2]

    }
  }
  ## If method is not NULL
  if(!is.null(method)){
    ### If method is all
    if(method[1] == "all"){
      method <- all_methods
    }
    if(any(c("scDesign", "SPsimSeq", "SCRIP", "zingeR", "zinbwaveZinger") %in% method)){
      ## ref data for these two methods
      if(is.matrix(ref_data)){
        ref_data <- list(ref_data = ref_data)
      }
      data_name <- paste0("refdata", 1:length(ref_data))
      if(!is.null(ref_data) & is.list(ref_data)){
        if(!is.null(parameters)){
          assertthat::assert_that(length(ref_data) == length(parameters),
                                  msg = "The number of reference datasets is not equal to the length of parameters that you have input!")
        }
      }
    }else{
      data_name <- "ref_data"
    }
  }
  ## Assert that method names are right
  assertthat::assert_that(all(method %in% all_methods))
  ### Method
  every_exec_method <- rep(method, each = n)
  every_data_name <- rep(data_name, each = n)
  ### Users set seed or not
  if(length(seed) != n){
    cat("The length of seeds is not identical to the time(s) that every method will be executed \n")
    seed <- seq_len(n)*100
    seed_chara <- paste(as.character(seed), collapse = " ")
    cat(paste0("The seed will be set as: ", seed_chara, " when performing every method\n"))
  }
  seed <- rep(seed, length(method))

  # Prepare parameters and ref_data---------------------------------------------
  parameters <- rep(parameters, each = n)
  if(!is.null(ref_data) & is.list(ref_data)){
    ref_data <- rep(ref_data, each = n)
  }
  # Run methods with each estimation and each method----------------------------
  result <- purrr::map(
    .x = seq_len(length(every_exec_method)),
    .f = function(id) {
      if(verbose){
        message(paste0("Simulating dataset ", id))
      }
      # Users have performed the estimation step
      if(!is.null(parameters)){
        parameters <- parameters[[id]][["estimate_result"]]
      }
      if(!is.null(other_prior)){
        if(all(data_name %in% names(other_prior))){
          other_prior_exec <- other_prior[[every_data_name[id]]]
        }else{
          other_prior_exec <- other_prior
        }
        other_prior_exec <- check_prior_info(method = every_exec_method[id],
                                             step = "simulation",
                                             other_prior = other_prior_exec)
      }else{
        other_prior_exec <- other_prior
      }
      if(!is.null(ref_data)){
        ref_data <- ref_data[[id]]
      }else{
        ref_data <- NULL
      }
      # Seed
      seed <- seed[id]
      method_execute_container_simulate(
        parameters = parameters,
        method = every_exec_method[id],
        ref_data = ref_data,
        other_prior = other_prior_exec,
        return_format = return_format,
        seed = seed,
        verbose = verbose
      )
    }
  )
  # Prepare list names----------------------------------------------------------
  if(is.null(parameters)){
    list_names <- paste0(every_exec_method, "_", rep(seq_len(n), length(method)))
  }else{
    list_names <- paste0(names(parameters), "_", rep(seq_len(n), length(method)))
  }
  result <- stats::setNames(result, list_names)
  result <- add_class(result, "simpipe_simulation")
  return(result)
}
